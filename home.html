<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // 1. Configuración
    const supabaseUrl = 'https://roogjmgxghbuiogpcswy.supabase.co'
    const supabaseKey = 'sb_publishable_RTN2PXvdWOQFfUySAaTa_g_LLe-T_NU'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // Variables globales
    let myChart = null;

    // Inicializar
    async function initDashboard() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            currentUserId = user.id; // Guardamos para el historial
            loadChartData(user.id);
            fetchHistory(1); // Cargar también el historial
        }
    }

    // Recargar gráfico al volver a la pestaña Inicio
    document.querySelector('.menu-btn[data-target="inicio"]').addEventListener('click', () => {
        if(myChart) myChart.resize(); 
        // Opcional: recargar datos frescos
        // loadChartData(currentUserId); 
    });

    async function loadChartData(userId) {
        // Rango: Últimos 15 días (para que se vean mejor los puntos)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 15);

        // 1. Obtener sesiones
        const { data: sesiones } = await supabase
            .from('sesiones_conduccion')
            .select('id_sesion')
            .eq('id_usuario', userId);
        
        const sessionIds = sesiones ? sesiones.map(s => s.id_sesion) : [];

        if (sessionIds.length === 0) {
            renderEmptyChart();
            return;
        }

        // 2. Obtener CAPTURAS (Datos minuto a minuto)
        const { data: capturas, error } = await supabase
            .from('Capturas')
            .select('hora_captura, nivel_riesgo_calculado')
            .in('id_sesion', sessionIds)
            .gte('hora_captura', startDate.toISOString())
            .order('hora_captura', { ascending: true });

        if (error) {
            console.error("Error gráfico:", error);
            return;
        }

        processAndRenderChart(capturas, startDate, endDate);
    }

    function processAndRenderChart(capturas, startDate, endDate) {
        const dailyStats = {};
        
        // Inicializar fechas vacías
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            dailyStats[dateStr] = { Normal: 0, Leve: 0, Moderado: 0, Alto: 0, Total: 0 };
        }

        // Llenar datos (Contamos minutos)
        capturas.forEach(c => {
            const dateStr = c.hora_captura.split('T')[0];
            if (dailyStats[dateStr]) {
                let nivel = c.nivel_riesgo_calculado || 'Normal';
                if (nivel === 'Alto riesgo') nivel = 'Alto';
                
                if (dailyStats[dateStr][nivel] !== undefined) {
                    dailyStats[dateStr][nivel]++; // +1 minuto aprox
                    dailyStats[dateStr].Total++;
                }
            }
        });

        // Convertir a PORCENTAJES (%)
        const labels = Object.keys(dailyStats);
        
        const dataNormal = [];
        const dataLeve = [];
        const dataModerado = [];
        const dataAlto = [];

        labels.forEach(date => {
            const day = dailyStats[date];
            const total = day.Total || 1; // Evitar división por cero

            // Calculamos el % de tiempo en cada estado
            // Si el total es 0 (no condujo), dejamos todo en 0
            if (day.Total === 0) {
                dataNormal.push(null); // null para que no dibuje punto
                dataLeve.push(null);
                dataModerado.push(null);
                dataAlto.push(null);
            } else {
                dataNormal.push((day.Normal / total) * 100);
                dataLeve.push((day.Leve / total) * 100);
                dataModerado.push((day.Moderado / total) * 100);
                dataAlto.push((day.Alto / total) * 100);
            }
        });

        renderChart(labels, dataNormal, dataLeve, dataModerado, dataAlto);
    }

    function renderChart(labels, dNormal, dLeve, dModerado, dAlto) {
        const ctx = document.getElementById('fatigueChart').getContext('2d');

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Normal (%)',
                        data: dNormal,
                        borderColor: '#10b981', // Verde
                        backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    },
                    {
                        label: 'Fatiga (%)',
                        data: dLeve,
                        borderColor: '#facc15', // Amarillo
                        backgroundColor: 'rgba(250, 204, 21, 0.4)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4
                    },
                    {
                        label: 'Somnolencia (%)',
                        data: dModerado,
                        borderColor: '#f97316', // Naranja
                        backgroundColor: 'rgba(249, 115, 22, 0.5)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5
                    },
                    {
                        label: 'Microsueño (%)',
                        data: dAlto,
                        borderColor: '#ef4444', // Rojo
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
                        grid: { color: '#334155', drawBorder: false }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100, // Fijamos el máximo en 100%
                        ticks: { 
                            color: '#94a3b8',
                            callback: function(value) { return value + "%" } // Añadir % al eje
                        },
                        grid: { color: '#334155', drawBorder: false },
                        title: {
                            display: true,
                            text: 'Distribución del Tiempo de Viaje',
                            color: '#cbd5e1'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#fff', usePointStyle: true, boxWidth: 8 }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: '#334155',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + '% del tiempo';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderEmptyChart() {
        const ctx = document.getElementById('fatigueChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Sin datos'],
                datasets: [{ label: 'Sin actividad', data: [], borderColor: '#334155' }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    // ==========================================
    // LÓGICA DEL HISTORIAL (Misma de antes)
    // ==========================================
    const tableBody = document.getElementById('historyTable');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const btnFilter = document.getElementById('applyFilters');
    let currentPage = 1;
    const pageSize = 10;
    let currentUserId = null;

    btnFilter.addEventListener('click', () => fetchHistory(1));
    prevBtn.addEventListener('click', () => { if(currentPage > 1) fetchHistory(currentPage - 1); });
    nextBtn.addEventListener('click', () => fetchHistory(currentPage + 1));

    async function fetchHistory(page) {
        if (!currentUserId) return;
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Cargando registros...</td></tr>';
        
        const fDate = document.getElementById('filterDate').value;
        const fType = document.getElementById('filterType').value;
        const fLevel = document.getElementById('filterLevel').value;
        const from = (page - 1) * pageSize;
        const to = from + pageSize - 1;

        const { data: sesiones } = await supabase.from('sesiones_conduccion').select('id_sesion').eq('id_usuario', currentUserId);
        const sessionIds = sesiones ? sesiones.map(s => s.id_sesion) : [];

        if (sessionIds.length === 0) { renderTable([], 0); return; }

        let query = supabase.from('Alertas').select('*', { count: 'exact' }).in('id_sesion', sessionIds).order('fecha_alerta', { ascending: false }).range(from, to);

        if (fLevel) query = query.eq('nivel_riesgo', fLevel);
        if (fType) query = query.ilike('causa_detonante', `%${fType}%`);
        if (fDate) {
            const startDate = new Date(fDate);
            const endDate = new Date(fDate);
            endDate.setDate(endDate.getDate() + 1);
            query = query.gte('fecha_alerta', startDate.toISOString()).lt('fecha_alerta', endDate.toISOString());
        }

        const { data, count, error } = await query;
        if (!error) { currentPage = page; renderTable(data, count); }
    }

    function renderTable(data, totalCount) {
        tableBody.innerHTML = '';
        if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No se encontraron alertas registradas.</td></tr>';
            pageInfo.textContent = `Página 1 de 1`;
            return;
        }
        data.forEach(alerta => {
            const row = document.createElement('tr');
            const fecha = new Date(alerta.fecha_alerta).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            let levelClass = 'level-normal';
            if (alerta.nivel_riesgo === 'Alto riesgo') levelClass = 'level-alto';
            if (alerta.nivel_riesgo === 'Moderado') levelClass = 'level-moderado';
            if (alerta.nivel_riesgo === 'Leve') levelClass = 'level-leve';

            let causaMostrar = alerta.causa_detonante || 'Desconocida';
            let valorDisplay = alerta.valor_medido ? alerta.valor_medido.toString() : '-';

            if (causaMostrar.includes("Somnolencia")) valorDisplay += " eventos"; 
            else if (causaMostrar.includes("Microsueño")) valorDisplay += " seg";
            else if (causaMostrar.includes("Bostezos")) valorDisplay += " veces";
            else if (causaMostrar.includes("Fatiga")) valorDisplay += " parpadeos/min";

            row.innerHTML = `<td>${fecha}</td><td>${causaMostrar}</td><td class="${levelClass}">${alerta.nivel_riesgo}</td><td>${valorDisplay}</td>`;
            tableBody.appendChild(row);
        });
        const totalPages = Math.ceil(totalCount / pageSize);
        pageInfo.textContent = `Página ${currentPage} de ${totalPages || 1}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages;
        prevBtn.style.opacity = currentPage === 1 ? "0.5" : "1";
        nextBtn.style.opacity = currentPage >= totalPages ? "0.5" : "1";
    }

    const menuBtns = document.querySelectorAll('.menu-btn');
    menuBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            menuBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            ['inicio','deteccion','usuarios','historial'].forEach(sec => {
                document.getElementById(sec).style.display = (sec === btn.dataset.target) ? 'block' : 'none';
            });
        });
    });

    initDashboard();
</script>